---
title: "Chapter 17"
author: "Lawrence Ramsay"
date: '2022-08-15'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if(!require("pacman")){
  install.packages("pacman")
}

pacman::p_load("rattle", "dplyr", "magrittr", "mltools", "data.table",
               "caret", "tree")

set.seed(6)                              
index <- caret::createDataPartition(wine$Type,p=0.8,list=FALSE)
train <- wine[index,]
test <- wine[-index,]

test_category <- test[["Type"]]
train_category <- train[["Type"]]

```

### Wine Dataset

```{r}

print(names(wine))
print(nrow(wine))

```

### Another Classifier - Nearest Neighbor

```{r}

tree <- rpart::rpart(Type~., data=wine, subset=index, cp = 0.01)

tree_pred = predict(tree, test, type="class")

with(test, table(tree_pred, Type))


```

```{r}

knn_pred <- class::knn(train=train,test=test,cl = train_category)

with(test, table(knn_pred, Type))

```

```{r}

print(paste("KNN Test Accuracy", round(sum(knn_pred == test_category) / length(test_category),2)))
print(paste("Decision Tree Test Accuracy", round(sum(tree_pred == test_category) / length(test_category),2)))

```

## Cross Validation

```{r}

trControl <- trainControl(method  = "cv",
                          number  = 10)

fit_knn_10fold <- train(Type ~ .,
             method     = "knn",
             tuneGrid   = expand.grid(k = 1),
             trControl  = trControl,
             metric     = "Accuracy",
             data       = wine)

print(paste0("KNN 10 fold Mean Accuracy: ", fit_knn_10fold$results$Accuracy))
print(paste0("KNN 10 fold Accuracy Standard Deviation: ", fit_knn_10fold$results$AccuracySD))
```

```{r}

folds <- 10
cvIndex <- createFolds(factor(wine$Type), folds, returnTrain = T)

trControl <- trainControl(index = cvIndex,
               method = 'cv', 
               number = folds)

fit_knn_strat_10fold <- train(Type ~ .,
             method     = "knn",
             tuneGrid   = expand.grid(k = 1),
             trControl  = trControl,
             metric     = "Accuracy",
             data       = wine)

print(paste0("KNN 10 fold stratified Mean Accuracy: ", fit_knn_strat_10fold$results$Accuracy))
print(paste0("KNN 10 fold stratified Accuracy Standard Deviation: ", fit_knn_strat_10fold$results$AccuracySD))
```

### Significance of Model Differences

```{r}
trControl <- trainControl(method  = "cv",
                          number  = 20)

fit_knn_20fold <- train(Type ~ .,
             method     = "knn",
             tuneGrid   = expand.grid(k = 1),
             trControl  = trControl,
             metric     = "Accuracy",
             data       = wine)

print(paste0("KNN 20 fold Mean Accuracy: ", fit_knn_20fold$results$Accuracy))
print(paste0("KNN 20 fold Accuracy Standard Deviation: ", fit_knn_20fold$results$AccuracySD))
```

```{r}

trControl <- trainControl(method  = "LOOCV")

fit_knn_loocv <- train(Type ~ .,
             method     = "knn",
             tuneGrid   = expand.grid(k = 1),
             trControl  = trControl,
             metric     = "Accuracy",
             data       = wine)

print(paste0("KNN LOOCV Mean Accuracy: ", fit_knn_loocv$results$Accuracy))
print(paste0("KNN LOOCV Accuracy Standard Deviation: ",  sd(fit_knn_loocv$results)))
```

```{r}

trControl <- trainControl(method  = "cv",
                          number  = 20)

fit_dt_20fold <- train(Type ~ .,
             method     = "rpart",
             trControl  = trControl,
             tuneGrid = expand.grid(cp = 0.01),
             metric     = "Accuracy",
             data       = wine)
print(paste0("Decision Tree Mean Accuracy: ", fit_dt_20fold$results$Accuracy))
print(paste0("Decision Tree Accuracy Standard Deviation: ", fit_dt_20fold$results$AccuracySD))

```


```{r}

print(paste0("KNN Mean Accuracy: ", fit_knn_20fold$results$Accuracy))
print(paste0("KNN Accuracy Standard Deviation: ", fit_knn_20fold$results$AccuracySD))

print(paste0("Decision Tree Mean Accuracy: ", fit_dt_20fold$results$Accuracy))
print(paste0("Decision Tree Accuracy Standard Deviation: ", fit_dt_20fold$results$AccuracySD))

wilcox.test(fit_dt_20fold$resample$Accuracy, fit_knn_20fold$resample$Accuracy, paired=TRUE, exact = FALSE, alternative = "two.sided")

```

### Hyper-parameter Tuning

```{r}

ggplot() +
  geom_line(aes(y=fit_dt_20fold$resample$Accuracy,
                x=1:length(fit_dt_20fold$resample$Resample))) +
  labs(y = "Accuracy", x= "Fold", title = "Decision Tree 20 fold accuracy") +
  scale_x_continuous(breaks=c(1:20))

```

```{r}

ggplot() +
  geom_line(aes(y=fit_knn_20fold$resample$Accuracy,
                x=1:length(fit_knn_20fold$resample$Resample))) +
  labs(y = "Accuracy", x= "Fold", title = "KNN 20 fold accuracy") +
  scale_x_continuous(breaks=c(1:20))

```

```{r}
folds <- 20
cvIndex <- createFolds(factor(wine$Type), folds, returnTrain = T)

trControl <- trainControl(index = cvIndex,
               method = 'cv', 
               number = folds)

fit_dt_strat_20fold <- train(Type ~ .,
             method     = "rpart",
             trControl  = trControl,
             tuneGrid = expand.grid(cp = 0.01),
             metric     = "Accuracy",
             data       = wine)

print(paste0("Decision Tree Mean Accuracy: ", fit_dt_strat_20fold$results$Accuracy))
print(paste0("Decision Tree Accuracy Standard Deviation: ", fit_dt_strat_20fold$results$AccuracySD))

fit_knn_strat_20fold <- train(Type ~ .,
             method     = "knn",
             tuneGrid   = expand.grid(k = 1),
             trControl  = trControl,
             metric     = "Accuracy",
             data       = wine)

print(paste0("KNN 20 fold stratified Mean Accuracy: ", fit_knn_strat_20fold$results$Accuracy))
print(paste0("KNN 20 fold stratified Accuracy Standard Deviation: ", fit_knn_strat_20fold$results$AccuracySD))

wilcox.test(fit_dt_strat_20fold$resample$Accuracy, 
paired=TRUE, exact = FALSE, fit_knn_strat_20fold$resample$Accuracy, alternative = "two.sided")

```


